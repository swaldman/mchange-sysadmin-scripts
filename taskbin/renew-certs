#!/usr/bin/env -S scala-cli shebang --server=false --suppress-directives-in-multiple-files-warning

//> using file ../project.scala

// for debugging
// tail -f /var/log/letsencrypt/letsencrypt.log

// when we run this noninteractively, we do it in a systemd timer,
// on an odd day with timing blurred by RandomizedDelaySec=3hr
//
// so there's no need for a random sleep to prevent a
// horde of simultaneous renewals

import scala.collection.immutable
import com.mchange.sysadmin.taskrunner.*

val taskRunner = TaskRunner[Unit]
import taskRunner.*

def itRan( completed : Completed ) : Boolean =
  val stdout = completed.result.stepOut
  stdout.contains("Certificate not yet due") || stdout.contains("Renewing an existing certificate")

val task = new Task:
  val name = "Renew certs"
  val init = ()
  val bestEffortSetups = Set.empty
  val sequential = List(
    Step.Exec("Stop nginx", List("systemctl", "stop", "nginx")),
    Step.Exec("Renew certs", List("certbot", "renew", "--standalone", "--no-random-sleep-on-renew"), isSuccess = itRan),
  )
  val bestEffortFollowups = Set(
    Step.Exec("Restart nginx", List("systemctl","restart","nginx"), essential=Some(true)) // we want to know about it if ngnix doesn't restart!
  )

val reporters = Reporters.default()

runAndReport(task,reporters)

